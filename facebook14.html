<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Memory Lane — Your Local Timeline</title>
  <!-- Force dark mode early to avoid flash -->
  <script>(function(){document.documentElement.classList.add('dark');})();</script>
  <script>window.tailwind=window.tailwind||{};tailwind.config={darkMode:'class'};</script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>html,body{height:100%;}</style>
</head>
<body class="bg-neutral-900 text-neutral-100">
  <!-- Background image with blur + dark overlay -->
  <div id="bg-wrap" class="fixed inset-0 -z-10 overflow-hidden">
    <img id="bg-img" alt="background" class="w-full h-full object-cover scale-110"/>
    <div class="absolute inset-0 bg-black/45"></div>
  </div>

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // ========= Storage Keys (v7.1) =========
    const KEY_POSTS = 'ml_posts_v7';
    const KEY_PROFILE = 'ml_profile_v6';
    const KEY_GROUPS = 'ml_groups_v6';
    const KEY_SETTINGS = 'ml_settings_v6'; // now also stores backgroundBlur + autoAI
    const KEY_CURRENT = 'ml_current_group_v6';
    const KEY_ONBOARDED = 'ml_onboarded_v1';

    const loadJson=(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}};
    const saveJson=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

    const uuid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
    const fmtTime=(ts)=>new Date(ts).toLocaleString();
    const timeAgo=(ts)=>{const s=Math.floor((Date.now()-ts)/1000),m=Math.floor(s/60),h=Math.floor(m/60),d=Math.floor(h/24),mo=Math.floor(d/30),y=Math.floor(d/365);if(y>0)return y+'y ago';if(mo>0)return mo+'mo ago';if(d>0)return d+'d ago';if(h>0)return h+'h ago';if(m>0)return m+'m ago';return 'just now'};

    async function compressImage(file,maxW=1024,quality=0.66){
      const img=new Image();const url=URL.createObjectURL(file);
      await new Promise((res,rej)=>{img.onload=res;img.onerror=rej;img.src=url});
      const scale=Math.min(1,maxW/(img.width||maxW));
      const w=Math.max(1,Math.round((img.width||maxW)*scale));
      const h=Math.max(1,Math.round((img.height||maxW)*scale));
      const c=document.createElement('canvas');c.width=w;c.height=h;const ctx=c.getContext('2d');
      ctx.drawImage(img,0,0,w,h);const data=c.toDataURL('image/jpeg',quality);URL.revokeObjectURL(url);return data;
    }
    async function compressAvatar(file,size=256,quality=0.92){
      const img=new Image();const url=URL.createObjectURL(file);
      await new Promise((res,rej)=>{img.onload=res;img.onerror=rej;img.src=url});
      const c=document.createElement('canvas');c.width=size;c.height=size;const ctx=c.getContext('2d');
      const scale=Math.max(size/(img.width||size),size/(img.height||size));const sw=size/scale,sh=size/scale;const sx=((img.width||size)-sw)/2;const sy=((img.height||size)-sh)/2;
      ctx.drawImage(img,sx,sy,sw,sh,0,0,size,size);const data=c.toDataURL('image/jpeg',quality);URL.revokeObjectURL(url);return data;
    }
    const fileToDataUrl=(file)=>new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(file)});
    function triggerDownload(blob,filename){const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(url),1500)}

    const defaultProfile={name:'You',avatarDataUrl:''};
    const defaultGroups=[{id:'home',name:'Home'}];

    function App(){
      // State
      const [profile,setProfile]=useState(loadJson(KEY_PROFILE,defaultProfile));
      const [groups,setGroups]=useState(loadJson(KEY_GROUPS,defaultGroups));
      const [currentGroupId,setCurrentGroupId]=useState(localStorage.getItem(KEY_CURRENT)||groups[0]?.id||'home');

      // Background image persistence (stored in settings)
      const initialSettings=loadJson(KEY_SETTINGS,{
        endpoint:'https://openrouter.ai/api/v1/chat/completions',
        model:'google/gemma-3-4b-it',
        apiKey:'',
        systemPrompt:'You are a friendly, concise commenter offering kind, specific, and safe feedback. Keep it to 1–2 sentences.',
        backgroundUrl:`https://picsum.photos/seed/${Math.floor(Math.random()*1e9)}/1920/1080`,
        backgroundBlur:32,
        autoAI:false
      });
      const [settings,setSettings]=useState(initialSettings);
      const [bgUrl,setBgUrl]=useState(initialSettings.backgroundUrl);
      const [bgBlur,setBgBlur]=useState(initialSettings.backgroundBlur ?? 32);
      const [showPrivacy,setShowPrivacy]=useState(false);
      const [showAbout,setShowAbout]=useState(false);
      const [showOnboarding,setShowOnboarding]=useState(false);

      // Filters & search (collapsed by default)
      const [filtersOpen,setFiltersOpen]=useState(false);
      const [filterGroup,setFilterGroup]=useState('current'); // 'current' | 'all'
      const [filterYear,setFilterYear]=useState('');
      const [filterMonth,setFilterMonth]=useState('');
      const [filterDay,setFilterDay]=useState('');
      const [filterText,setFilterText]=useState('');

      const demoWelcome=[{id:uuid(),groupId:'home',author:{name:'Memory Lane',avatarDataUrl:''},text:'Welcome! Everything stays in your browser. Use Collections to categorize. Click the avatar circle to set a profile image.',imageDataUrl:'',createdAt:Date.now(),likes:1,comments:[{id:uuid(),author:'Memory Lane',text:'Use Export Data after changes to keep a copy.',createdAt:Date.now(),likes:0}]}];
      const [posts,setPosts]=useState(loadJson(KEY_POSTS,[]).length?loadJson(KEY_POSTS,[]):demoWelcome);

      // Apply bg image + blur
      useEffect(()=>{const el=document.getElementById('bg-img');if(el){el.src=bgUrl;el.style.filter=`blur(${bgBlur}px)`;}},[bgUrl,bgBlur]);

      // Persist
      useEffect(()=>saveJson(KEY_PROFILE,profile),[profile]);
      useEffect(()=>saveJson(KEY_GROUPS,groups),[groups]);
      useEffect(()=>saveJson(KEY_POSTS,posts),[posts]);
      useEffect(()=>{const s={...settings,backgroundUrl:bgUrl,backgroundBlur:bgBlur};saveJson(KEY_SETTINGS,s)},[settings,bgUrl,bgBlur]);
      useEffect(()=>localStorage.setItem(KEY_CURRENT,currentGroupId),[currentGroupId]);

      // First-run onboarding
      useEffect(()=>{
        try{
          const seen = localStorage.getItem(KEY_ONBOARDED);
          if(!seen){ setShowOnboarding(true); }
        }catch{}
      },[]);

      // Collections ops
      const addCollection=(name)=>{const t=(name||'').trim();if(!t)return;const g={id:uuid(),name:t};setGroups(p=>[...p,g]);setCurrentGroupId(g.id)};
      const renameCollection=(id,name)=>setGroups(p=>p.map(g=>g.id===id?{...g,name}:g));
      const deleteCollection=(id)=>{ if(id==='home') return; setGroups(p=>p.filter(g=>g.id!==id)); setPosts(p=>p.filter(x=>x.groupId!==id)); if(currentGroupId===id)setCurrentGroupId('home')};

      // Post ops
      const addPost=(post)=>{
        setPosts(p=>[post,...p]);
        // Auto AI: trigger immediately using the exact post object to avoid state-staleness
        if(settings.autoAI && settings.apiKey){ aiCommentForPost(post); }
      };
      const likePost=(id)=>setPosts(p=>p.map(x=>x.id===id?{...x,likes:x.likes+1}:x));
      const deletePost=(id)=>setPosts(p=>p.filter(x=>x.id!==id));
      const addComment=(id,comment)=>{
        // Build the updated post locally so the AI sees the latest comment
        let updatedForAI=null;
        setPosts(p=>p.map(x=>{
          if(x.id!==id) return x;
          const updated={...x,comments:[...x.comments,comment]};
          updatedForAI = updated;
          return updated;
        }));
        if(settings.autoAI && settings.apiKey && (comment.author||'')!=='AI'){
          aiCommentForPost(updatedForAI||id);
        }
      };
      const likeComment=(postId,commentId)=>setPosts(p=>p.map(x=>x.id===postId?{...x,comments:x.comments.map(c=>c.id===commentId?{...c,likes:(c.likes||0)+1}:c)}:x));
      const deleteComment=(postId,commentId)=>setPosts(p=>p.map(x=>x.id===postId?{...x,comments:x.comments.filter(c=>c.id!==commentId)}:x));

      // AI generation at App level (for autoAI)
      async function aiCommentForPost(postOrId){
        try{
          const post = (postOrId && typeof postOrId==='object') ? postOrId : posts.find(p=>p.id===postOrId);
          if(!post) return;
          const messages=[];
          if (settings.systemPrompt) messages.push({role:'system',content:settings.systemPrompt});
          const firstContent=[{type:'text', text:`Here is a social post. Reply with one friendly, concise comment in 1–2 sentences.

POST:
${(post.text||'').trim()||'(image only)'}

Guidelines: Be supportive, avoid personal data, and no medical/legal/financial/mental health advice.`}];
          if(post.imageDataUrl){ firstContent.push({type:'image_url', image_url:{url:post.imageDataUrl}}); }
          messages.push({role:'user',content:firstContent});
          const sorted=[...(post.comments||[])].sort((a,b)=>a.createdAt-b.createdAt);
          for(const c of sorted){ const role = (c.author||'').toLowerCase()==='ai'?'assistant':'user'; messages.push({role,content:[{type:'text',text:c.text||''}]}); }
          const resp=await fetch(settings.endpoint||'https://openrouter.ai/api/v1/chat/completions',{
            method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+settings.apiKey,'HTTP-Referer':location.origin,'X-Title':'Memory Lane Local'},body:JSON.stringify({model:settings.model||'openrouter/auto',messages,temperature:0.7,max_tokens:160})});
          if(!resp.ok) throw new Error('HTTP '+resp.status);
          const data=await resp.json();
          const text=(data&&data.choices&&data.choices[0]&&data.choices[0].message&&data.choices[0].message.content)?data.choices[0].message.content.trim():'(AI had no comment)';
          const aiC={id:uuid(),author:'AI',text,createdAt:Date.now(),likes:0};
          setPosts(p=>p.map(x=>x.id===post.id?{...x,comments:[...x.comments,aiC]}:x));
        }catch(err){ console.warn('Auto AI failed',err); }
      }

      // Filtering
      const matchesDate=(ts)=>{const d=new Date(ts);if(filterYear&&d.getFullYear()!==Number(filterYear))return false;if(filterMonth&&(d.getMonth()+1)!==Number(filterMonth))return false;if(filterDay&&d.getDate()!==Number(filterDay))return false;return true};
      const matchesText=(post)=>{const q=filterText.trim().toLowerCase();if(!q)return true;if((post.text||'').toLowerCase().includes(q))return true;return post.comments?.some(c=>(c.text||'').toLowerCase().includes(q))};
      const feedSource=useMemo(()=>{const base=(filterGroup==='all')?posts:posts.filter(p=>p.groupId===currentGroupId);return base.filter(p=>matchesDate(p.createdAt)&&matchesText(p)).sort((a,b)=>b.createdAt-a.createdAt)},[posts,currentGroupId,filterGroup,filterYear,filterMonth,filterDay,filterText]);
      const grouped=useMemo(()=>{const fmt=d=>d.toISOString().slice(0,10);const map=new Map();for(const p of feedSource){const key=fmt(new Date(p.createdAt));if(!map.has(key))map.set(key,[]);map.get(key).push(p)}return Array.from(map.entries()).sort((a,b)=>new Date(b[0])-new Date(a[0]))},[feedSource]);

      // Export/Import
      const exportData=()=>{
        const payload={version:7.1,profile,groups,currentGroupId,posts,settings:{...settings,backgroundUrl:bgUrl,backgroundBlur:bgBlur}};
        const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
        triggerDownload(blob,'memory-lane-data-'+new Date().toISOString().slice(0,10)+'.json');
      };
      const importInputRef=useRef(null);
      const doImport=(evt)=>{
        const file=evt.target.files?.[0];if(!file)return;const fr=new FileReader();
        fr.onload=()=>{
          try{
            const data=JSON.parse(fr.result);
            if(!data||!data.posts||!data.profile||!data.groups) throw new Error('Invalid file');
            saveJson(KEY_PROFILE,data.profile);
            saveJson(KEY_GROUPS,data.groups);
            saveJson(KEY_POSTS,data.posts);
            saveJson(KEY_SETTINGS,data.settings||settings);
            localStorage.setItem(KEY_CURRENT,data.currentGroupId||'home');
            setProfile(data.profile);
            setGroups(data.groups);
            setPosts(data.posts);
            setSettings(data.settings||settings);
            setCurrentGroupId(data.currentGroupId||'home');
            setBgUrl((data.settings&&data.settings.backgroundUrl)||bgUrl);
            setBgBlur((data.settings&&data.settings.backgroundBlur)??bgBlur);
          }catch(e){alert('Import failed: '+e.message)}
        };
        fr.readAsText(file);
      };

      // Reset all
      const resetAll=()=>{
        if(!confirm('Reset ALL Memory Lane data in this browser? This deletes posts, comments, settings, and collections.')) return;
        try{
          localStorage.removeItem(KEY_POSTS);
          localStorage.removeItem(KEY_PROFILE);
          localStorage.removeItem(KEY_GROUPS);
          localStorage.removeItem(KEY_SETTINGS);
          localStorage.removeItem(KEY_CURRENT);
          setProfile(defaultProfile);
          setGroups(defaultGroups);
          setCurrentGroupId('home');
          setPosts(demoWelcome);
          setSettings(initialSettings);
          setBgUrl(initialSettings.backgroundUrl);
          setBgBlur(initialSettings.backgroundBlur);
        }catch(e){ alert('Reset failed: '+(e?.message||e)); }
      };

      // Render
      const [openSettings,setOpenSettings]=useState(false);

      return (
        <div className="min-h-screen">
          <Header
            profile={profile}
            setProfile={setProfile}
            onExportData={exportData}
            onOpenSettings={()=>setOpenSettings(true)}
            onOpenAbout={()=>setShowAbout(true)}
            onOpenOnboarding={()=>setShowOnboarding(true)}
            importInputRef={importInputRef}
            onImportClick={()=>importInputRef.current?.click()}
            onImportChange={doImport}
          />

          {openSettings && (
            <SettingsModal
              settings={settings}
              onClose={()=>setOpenSettings(false)}
              onSave={(s)=>{setSettings(s); setBgBlur(s.backgroundBlur??bgBlur);}}
              bgUrl={bgUrl}
              setBgUrl={setBgUrl}
              profile={profile}
              setProfile={setProfile}
              onResetAll={resetAll}
            />
          )}

          {/* Warning banner */}
          <div className="sticky top-14 z-10">
            <div className="max-w-7xl mx-auto px-2 sm:px-4">
              <div className="mt-2 rounded-xl bg-yellow-500/10 border border-yellow-600/40 text-yellow-200 px-4 py-2 text-xs">
                Changes are saved locally only. Use <b>Export Data</b> after any change to keep a private copy.
              </div>
            </div>
          </div>

          <main className="max-w-7xl mx-auto px-2 sm:px-4 py-6 grid grid-cols-12 gap-6">
            <LeftSidebar
              groups={groups}
              currentGroupId={currentGroupId}
              setCurrentGroupId={setCurrentGroupId}
              addCollection={addCollection}
              renameCollection={renameCollection}
              deleteCollection={(id)=>{ if(confirm('Delete this collection and all its posts? This cannot be undone.')) deleteCollection(id); }}
            />

            {/* Centered feed column */}
            <section className="col-span-12 md:col-span-7 lg:col-span-6 mx-auto w-full max-w-2xl space-y-5">
              <Filters
                filterGroup={filterGroup}
                setFilterGroup={setFilterGroup}
                filterYear={filterYear}
                filterMonth={filterMonth}
                filterDay={filterDay}
                setFilterYear={setFilterYear}
                setFilterMonth={setFilterMonth}
                setFilterDay={setFilterDay}
                filtersOpen={filtersOpen}
                setFiltersOpen={setFiltersOpen}
                filterText={filterText}
                setFilterText={setFilterText}
              />

              <CreatePostCard
                profile={profile}
                setProfile={setProfile}
                currentGroupId={currentGroupId}
                onCreate={addPost}
              />

              {/* Timeline */}
              <div className="relative">
                <div className="absolute left-2 sm:left-3 top-0 bottom-0 w-px bg-neutral-500/60"></div>
                <div className="space-y-8">
                  {grouped.map(([dateKey, posts]) => (
                    <div key={dateKey} className="relative pl-8 sm:pl-10">
                      <div className="absolute left-0 sm:left-1 top-1.5 w-3 h-3 rounded-full bg-neutral-300"></div>
                      <DateSeparator dateKey={dateKey} />
                      <div className="mt-3 space-y-5">
                        {posts.map(p => (
                          <PostCard
                            key={p.id}
                            post={p}
                            onLike={() => likePost(p.id)}
                            onDelete={() => { if(confirm('Delete this post?')) deletePost(p.id); }}
                            onAddComment={(t) => addComment(p.id, { id: uuid(), author: profile.name, text: t, createdAt: Date.now(), likes: 0 })}
                            onLikeComment={(cid) => likeComment(p.id, cid)}
                            onDeleteComment={(cid) => deleteComment(p.id, cid)}
                            settings={settings}
                            onAddAIComment={(text) => addComment(p.id, { id: uuid(), author: 'AI', text, createdAt: Date.now(), likes: 0 })}
                            viewerName={profile.name||'You'}
                          />
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </section>

            <footer className="col-span-12 text-center text-xs text-neutral-400 mt-2">
              <button className="underline underline-offset-2" onClick={()=>setShowPrivacy(true)}>Privacy Policy</button>
            </footer>
          </main>

          {showPrivacy && <PrivacyModal onClose={()=>setShowPrivacy(false)} />}
          {showAbout && <AboutModal onClose={()=>setShowAbout(false)} />}
          {showOnboarding && <OnboardingModal onClose={()=>{ setShowOnboarding(false); try{ localStorage.setItem(KEY_ONBOARDED,'1'); }catch{} }} onStart={()=>{ setShowOnboarding(false); try{ localStorage.setItem(KEY_ONBOARDED,'1'); }catch{} }} />}
        </div>
      );
    }

    function DateSeparator({ dateKey }){
      const d=new Date(dateKey+'T00:00:00');const today=new Date();const days=Math.floor((today-d)/(1000*60*60*24));
      const label=d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric',year:d.getFullYear()!==today.getFullYear()?'numeric':undefined});
      const rel=days===0?'Today':days===1?'Yesterday':days+'d ago';
      return (<div className="inline-flex items-center gap-2 text-xs sm:text-sm text-neutral-100 font-medium bg-neutral-900/70 px-2 py-1 rounded-full border border-neutral-700"><span>{label}</span><span className="opacity-70">· {rel}</span></div>);
    }

    // ===== Header (Export/Import + Settings, avatar hint) =====
    function Header({ profile,setProfile,onExportData,onOpenSettings,onOpenAbout,onOpenOnboarding,importInputRef,onImportClick,onImportChange }){
      const fileRef=useRef(null);
      const onAvatarPick=async(e)=>{const file=e.target.files?.[0];if(!file)return;const data=await compressAvatar(file,256,0.92);setProfile(prev=>({...prev,avatarDataUrl:data}))};
      return (
        <header className="w-full bg-neutral-950/70 backdrop-blur border-b border-neutral-800 sticky top-0 z-30">
          <div className="max-w-7xl mx-auto px-2 sm:px-4 h-14 flex items-center gap-3">
            <div className="font-semibold tracking-wide">Memory Lane</div>
            <div className="ml-auto flex items-center gap-2">
              <button className="h-9 px-3 rounded-full border border-neutral-700" onClick={onOpenAbout}>What is this?</button>
              <button className="h-9 px-3 rounded-full border border-neutral-700" onClick={onExportData}>Export Data</button>
              <button className="h-9 px-3 rounded-full border border-neutral-700" onClick={onImportClick}>Import Data</button>
              <input type="file" accept="application/json" className="hidden" ref={importInputRef} onChange={onImportChange} />
              <button className="h-9 px-3 rounded-full border border-neutral-700" onClick={onOpenSettings}>Settings</button>
              <button className="w-9 h-9 rounded-full border border-neutral-700 grid place-items-center text-neutral-300" title="Quick tour" onClick={onOpenOnboarding}>?</button>
              <button className="relative w-9 h-9 rounded-full bg-neutral-700 overflow-hidden" onClick={()=>fileRef.current?.click()} title="Change avatar">
                {profile.avatarDataUrl ? (
                  <img src={profile.avatarDataUrl} alt="avatar" className="w-full h-full object-cover" />
                ) : (
                  <span className="absolute inset-0 grid place-items-center text-[10px] text-neutral-300">Click to set</span>
                )}
              </button>
              <input type="file" accept="image/*" className="hidden" ref={fileRef} onChange={onAvatarPick} />
            </div>
          </div>
        </header>
      );
    }

    function AboutModal({ onClose }){
      return (
        <div className="fixed inset-0 z-50">
          <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
          <div className="relative w-full h-full flex items-start justify-center p-4 overflow-auto">
            <div className="w-full max-w-xl mt-10 bg-neutral-900 rounded-2xl border border-neutral-700 shadow-xl p-5">
              <div className="flex items-center justify-between mb-3">
                <div className="font-semibold text-lg">What is Memory Lane?</div>
                <button onClick={onClose} className="text-sm">Close</button>
              </div>
              <div className="text-sm space-y-3 text-neutral-200">
                <p><b>Privacy-first.</b> Your posts, images, comments, groups, and settings live entirely in your browser’s local storage. Nothing is uploaded to any server. You control your data.</p>
                <p><b>Portable.</b> With one click you can <i>Export</i> a tidy JSON file and later <i>Import</i> it on any device to continue where you left off.</p>
                <p><b>Simple.</b> Create posts, group them into collections, search, and filter by date. It feels like a familiar timeline without the noise.</p>
                <p><b>Optional AI comments.</b> Tap <i>AI Comment</i> to get a short, friendly reply. Enable <i>Auto‑run AI</i> in Settings to automatically add an AI reply after new posts or comments. Your API key is used directly in your browser to talk to the model provider you choose.</p>
                <p><b>How it works.</b> When AI runs, it sees the post (and image) plus the full comment thread in order—so responses consider the latest context.</p>
              </div>
              <div className="mt-4 text-right">
                <button className="h-9 px-3 rounded-full border border-neutral-700" onClick={onClose}>Got it</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function OnboardingModal({ onClose, onStart }){
      return (
        <div className="fixed inset-0 z-50">
          <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
          <div className="relative w-full h-full flex items-start justify-center p-4 overflow-auto">
            <div className="w-full max-w-2xl mt-10 bg-neutral-900 rounded-2xl border border-neutral-700 shadow-xl p-6">
              <div className="flex items-center justify-between mb-2">
                <div className="font-semibold text-lg">Welcome to Memory Lane</div>
                <button onClick={onClose} className="text-sm">Skip</button>
              </div>
              <div className="grid sm:grid-cols-3 gap-4 text-sm">
                <div className="p-3 rounded-xl bg-neutral-800/60 border border-neutral-700">
                  <div className="font-medium mb-1">1. Create</div>
                  <p>Write a post, attach an image, and save. Everything stays local to your browser.</p>
                </div>
                <div className="p-3 rounded-xl bg-neutral-800/60 border border-neutral-700">
                  <div className="font-medium mb-1">2. Organize</div>
                  <p>Use <b>Collections</b> on the left to group posts. Search and filter by date anytime.</p>
                </div>
                <div className="p-3 rounded-xl bg-neutral-800/60 border border-neutral-700">
                  <div className="font-medium mb-1">3. Enhance</div>
                  <p>Click <i>AI Comment</i> for a friendly reply, or enable <b>Auto‑run AI</b> in Settings.</p>
                </div>
              </div>
              <div className="mt-4 text-neutral-300 text-sm space-y-2">
                <p><b>Privacy, portability, simplicity</b> — no sign‑ups, no feeds, no tracking. Export/Import to carry your timeline anywhere.</p>
                <p>If AI is enabled, requests are sent from your browser straight to your chosen provider using your API key.</p>
              </div>
              <div className="mt-5 flex items-center justify-end gap-2">
                <button className="h-9 px-3 rounded-full border border-neutral-700" onClick={onClose}>Close</button>
                <button className="h-9 px-4 rounded-full bg-blue-600 text-white" onClick={onStart}>Start using Memory Lane</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function SettingsModal({ settings,onClose,onSave,bgUrl,setBgUrl,profile,setProfile,onResetAll }){
      const [local,setLocal]=useState(settings);
      const [name,setName]=useState(profile.name||'You');
      const randomizeBg=()=>{const url=`https://picsum.photos/seed/${Math.floor(Math.random()*1e9)}/1920/1080`;setBgUrl(url)};
      const save=()=>{onSave(local);setProfile(p=>({...p,name}));onClose();};
      return (
        <div className="fixed inset-0 z-50">
          <div className="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
          <div className="relative w-full h-full flex items-start justify-center p-4 overflow-auto">
            <div className="w-full max-w-lg mt-10 bg-neutral-900 rounded-2xl border border-neutral-700 shadow-xl p-5">
              <div className="flex items-center justify-between mb-3">
                <div className="font-semibold text-lg">Settings</div>
                <button onClick={onClose} className="text-sm">Close</button>
              </div>
              <div className="space-y-4 text-sm">
                <div>
                  <label className="text-sm font-medium">Display Name</label>
                  <input value={name} onChange={e=>setName(e.target.value)} className="mt-1 w-full h-10 px-3 rounded border border-neutral-700 bg-neutral-800"/>
                </div>
                <div className="grid sm:grid-cols-2 gap-3">
                  <div>
                    <label className="text-sm font-medium">OpenRouter Endpoint</label>
                    <input value={local.endpoint} onChange={e=>setLocal(v=>({...v,endpoint:e.target.value}))} className="mt-1 w-full h-10 px-3 rounded border border-neutral-700 bg-neutral-800"/>
                    <p className="text-xs text-neutral-400 mt-1">Default: https://openrouter.ai/api/v1/chat/completions</p>
                  </div>
                  <div>
                    <label className="text-sm font-medium">Model</label>
                    <input value={local.model} onChange={e=>setLocal(v=>({...v,model:e.target.value}))} className="mt-1 w-full h-10 px-3 rounded border border-neutral-700 bg-neutral-800"/>
                  </div>
                </div>
                <div>
                  <label className="text-sm font-medium">API Key</label>
                  <input value={local.apiKey} onChange={e=>setLocal(v=>({...v,apiKey:e.target.value}))} className="mt-1 w-full h-10 px-3 rounded border border-neutral-700 bg-neutral-800" placeholder="sk-or-v1-..."/>
                </div>
                <div>
                  <label className="text-sm font-medium">System Prompt (optional)</label>
                  <textarea value={local.systemPrompt} onChange={e=>setLocal(v=>({...v,systemPrompt:e.target.value}))} className="mt-1 w-full p-3 rounded border border-neutral-700 bg-neutral-800" rows="3"/>
                </div>

                <div className="grid sm:grid-cols-2 gap-3">
                  <div>
                    <label className="text-sm font-medium">Background URL</label>
                    <input value={bgUrl} onChange={e=>setBgUrl(e.target.value)} className="mt-1 w-full h-10 px-3 rounded border border-neutral-700 bg-neutral-800" placeholder="https://..."/>
                    <button className="mt-2 h-8 px-3 rounded-full border border-neutral-700" onClick={randomizeBg}>Randomize</button>
                  </div>
                  <div>
                    <label className="text-sm font-medium">Background Blur ({local.backgroundBlur??32}px)</label>
                    <input type="range" min="0" max="40" value={local.backgroundBlur??32} onChange={e=>{const v=Number(e.target.value); setLocal(s=>({...s,backgroundBlur:v}));}} className="mt-2 w-full"/>
                    <p className="text-xs text-neutral-400 mt-1">Applies to blurred wallpaper behind content.</p>
                  </div>
                </div>

                <div className="flex items-center gap-2">
                  <input id="autoai" type="checkbox" checked={!!local.autoAI} onChange={e=>setLocal(v=>({...v,autoAI:e.target.checked}))} />
                  <label htmlFor="autoai" className="select-none">Auto‑run AI Comment after new posts and comments</label>
                </div>

                <div className="text-xs text-yellow-300/90 bg-yellow-500/10 border border-yellow-600/40 rounded p-2">Reminder: this app stores data locally. Use <b>Export Data</b> after changes.</div>

                <div className="pt-2 border-t border-neutral-800">
                  <div className="text-sm font-semibold mb-1">Danger zone</div>
                  <button className="h-9 px-3 rounded-full border border-red-500 text-red-300" onClick={onResetAll}>Reset ALL local data</button>
                </div>
              </div>
              <div className="mt-4 flex justify-end gap-2">
                <button className="h-9 px-3 rounded-full border border-neutral-700" onClick={onClose}>Cancel</button>
                <button className="h-9 px-3 rounded-full bg-blue-600 text-white" onClick={save}>Save</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ===== Left Sidebar (Collections) =====
    function LeftSidebar({ groups,currentGroupId,setCurrentGroupId,addCollection,renameCollection,deleteCollection }){
      const [newName,setNewName]=useState('');
      const [editingId,setEditingId]=useState(null);
      const [editVal,setEditVal]=useState('');
      const onAdd=()=>{addCollection(newName);setNewName('')};
      return (
        <aside className="hidden md:block md:col-span-3 lg:col-span-3 space-y-3 justify-self-start">
          <div className="sticky top-20 p-4 rounded-2xl bg-neutral-900/90 backdrop-blur border border-neutral-700">
            <div className="font-semibold mb-2">Collections</div>
            <div className="space-y-1">
              {groups.map(g=> (
                <div key={g.id} className={`flex items-center gap-2 p-2 rounded cursor-pointer ${currentGroupId===g.id?'bg-neutral-800 border border-neutral-700':'hover:bg-neutral-800/60'}`}>
                  <div className="flex-1" onClick={()=>setCurrentGroupId(g.id)}>
                    <div className="font-medium text-sm">{g.name}</div>
                  </div>
                  {g.id!=='home' && (
                    <>
                      {editingId===g.id? (
                        <>
                          <input value={editVal} onChange={e=>setEditVal(e.target.value)} className="h-8 px-2 border border-neutral-700 bg-neutral-800 rounded" />
                          <button className="text-xs" onClick={()=>{renameCollection(g.id,(editVal||'').trim()||g.name);setEditingId(null)}}>Save</button>
                        </>
                      ): (
                        <>
                          <button className="text-xs" onClick={()=>{setEditingId(g.id);setEditVal(g.name)}}>Rename</button>
                          <button className="text-xs text-red-400" onClick={()=>deleteCollection(g.id)}>Delete</button>
                        </>
                      )}
                    </>
                  )}
                </div>
              ))}
            </div>
            <div className="mt-3 flex items-center gap-2">
              <input value={newName} onChange={e=>setNewName(e.target.value)} className="flex-1 h-9 px-3 rounded border border-neutral-700 bg-neutral-800" placeholder="New collection name" />
              <button onClick={onAdd} className="h-9 px-3 rounded bg-blue-600 text-white">Add</button>
            </div>
          </div>
        </aside>
      );
    }

    // ===== Filters (improved layout) =====
    function Filters({ filterGroup,setFilterGroup,filterYear,filterMonth,filterDay,setFilterYear,setFilterMonth,setFilterDay,filtersOpen,setFiltersOpen,filterText,setFilterText }){
      return (
        <div className="rounded-2xl bg-neutral-900/80 backdrop-blur border border-neutral-700 text-sm">
          <div className="p-3 flex flex-wrap items-center gap-3">
            <button className="h-9 px-3 rounded-full border border-neutral-700" onClick={()=>setFiltersOpen(v=>!v)}>
              {filtersOpen?'Hide filters':'Filter'}
            </button>
            <div className="ml-auto flex items-center gap-2 w-full sm:w-auto">
              <input value={filterText} onChange={(e)=>setFilterText(e.target.value)} placeholder="Search text…" className="w-full sm:w-64 h-9 px-3 rounded-full border border-neutral-700 bg-neutral-800"/>
            </div>
          </div>
          <div className={`overflow-hidden transition-all duration-300 ease-in-out ${filtersOpen?'max-h-96 opacity-100':'max-h-0 opacity-0'} px-3`}> 
            <div className="py-3 grid grid-cols-2 sm:grid-cols-6 gap-3">
              <div className="col-span-2 sm:col-span-2">
                <label className="text-xs block mb-1">Scope</label>
                <select value={filterGroup} onChange={(e)=>setFilterGroup(e.target.value)} className="w-full h-9 px-2 rounded border border-neutral-700 bg-neutral-800">
                  <option value="current">Current collection</option>
                  <option value="all">All collections</option>
                </select>
              </div>
              <div>
                <label className="text-xs block mb-1">Year</label>
                <input value={filterYear} onChange={(e)=>setFilterYear(e.target.value)} inputMode="numeric" placeholder="YYYY" className="w-full h-9 px-2 rounded border border-neutral-700 bg-neutral-800" />
              </div>
              <div>
                <label className="text-xs block mb-1">Month</label>
                <input value={filterMonth} onChange={(e)=>setFilterMonth(e.target.value)} inputMode="numeric" placeholder="MM" className="w-full h-9 px-2 rounded border border-neutral-700 bg-neutral-800" />
              </div>
              <div>
                <label className="text-xs block mb-1">Day</label>
                <input value={filterDay} onChange={(e)=>setFilterDay(e.target.value)} inputMode="numeric" placeholder="DD" className="w-full h-9 px-2 rounded border border-neutral-700 bg-neutral-800" />
              </div>
              <div className="col-span-2 sm:col-span-1 flex items-end justify-end">
                <button className="h-9 px-3 rounded-full border border-neutral-700 w-full sm:w-auto" onClick={()=>{setFilterGroup('current');setFilterYear('');setFilterMonth('');setFilterDay('');setFilterText('')}}>Clear all</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ===== Create Post =====
    function CreatePostCard({ profile,setProfile,currentGroupId,onCreate }){
      const [text,setText]=useState('');
      const [img,setImg]=useState('');
      const fileRef=useRef(null);

      const onFile=async(e)=>{const file=e.target.files?.[0];if(!file)return;try{const compressed=await compressImage(file,1024,0.66);setImg(compressed)}catch{const fallback=await fileToDataUrl(file);setImg(fallback)}};
      const submit=()=>{const trimmed=(text||'').trim();if(!trimmed&&!img)return;const post={id:uuid(),groupId:currentGroupId,author:{name:profile.name||'You',avatarDataUrl:profile.avatarDataUrl||''},text:trimmed,imageDataUrl:img,createdAt:Date.now(),likes:0,comments:[]};onCreate(post);setText('');setImg('')};
      const onKeyDown=(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();submit()}};

      return (
        <div className="p-4 rounded-2xl bg-neutral-900/90 backdrop-blur border border-neutral-700">
          <div className="flex items-center gap-3 mb-3">
            <button className="relative w-10 h-10 rounded-full bg-neutral-700 overflow-hidden" onClick={()=>fileRef.current?.click()} title="Change avatar">
              {profile.avatarDataUrl? <img src={profile.avatarDataUrl} className="w-full h-full object-cover" alt="avatar"/> : <span className="absolute inset-0 grid place-items-center text-[10px] text-neutral-300">Click to set</span>}
            </button>
            <div className="text-sm text-neutral-300">Posting as <span className="font-medium">{profile.name||'You'}</span> to <b>{currentGroupId==='home'?'Home':'Collection'}</b></div>
            <input type="file" accept="image/*" className="hidden" ref={fileRef} onChange={async(e)=>{const f=e.target.files?.[0];if(!f)return;const data=await compressAvatar(f,256,0.92);setProfile(prev=>({...prev,avatarDataUrl:data}))}} />
          </div>

          <textarea value={text} onChange={(e)=>setText(e.target.value)} onKeyDown={onKeyDown} placeholder="What's on your mind? (Enter to post, Shift+Enter for newline)" rows={3} className="w-full p-3 rounded-xl border border-neutral-700 bg-neutral-800 focus:outline-none" />

          {img && (<div className="mt-3"><img src={img} alt="preview" className="rounded-xl border border-neutral-700 max-h-80 object-contain"/></div>)}

          <div className="mt-3 flex items-center gap-3 text-sm text-neutral-300">
            <label className="h-9 px-3 rounded-full border border-neutral-700 grid place-items-center cursor-pointer">
              <input type="file" accept="image/*" className="hidden" onChange={onFile} />
              Add photo
            </label>
            <button onClick={submit} className="h-9 px-4 rounded-full bg-blue-600 text-white hover:bg-blue-700">Post</button>
            <span className="ml-auto text-xs text-neutral-400">Saved locally</span>
          </div>
        </div>
      );
    }

    // ===== Post Card =====
    function PostCard({ post,onLike,onDelete,onAddComment,onLikeComment,onDeleteComment,settings,onAddAIComment,viewerName }){
      const [comment,setComment]=useState('');
      const [aiBusy,setAiBusy]=useState(false);
      const [error,setError]=useState('');

      const submitComment=()=>{const t=(comment||'').trim();if(!t)return;onAddComment(t);setComment('')};
      const onKeyDown=(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();submitComment()}};

      function buildMessages(){
        const messages=[];
        if (settings.systemPrompt) messages.push({ role:'system', content: settings.systemPrompt });
        const firstContent=[];
        const postText=(post.text||'').trim();
        firstContent.push({ type:'text', text: `Here is a social post. Reply with one friendly, concise comment in 1–2 sentences.

POST:
${postText || '(image only)'}

Guidelines: Be supportive, avoid personal data, and no medical/legal/financial/mental health advice.` });
        if (post.imageDataUrl) firstContent.push({ type:'image_url', image_url: { url: post.imageDataUrl } });
        messages.push({ role:'user', content: firstContent });
        const sorted = [...(post.comments||[])].sort((a,b)=>a.createdAt-b.createdAt);
        for (const c of sorted) {
          const role = (c.author||'').toLowerCase()==='ai' ? 'assistant' : 'user';
          const name = (role==='user' ? (c.author||viewerName||'User') : undefined);
          const content = [{ type:'text', text: c.text || '' }];
          const msg = { role, content };
          if (name) msg.name = name;
          messages.push(msg);
        }
        return messages;
      }

      const askAI=async()=>{
        setError(''); if(!settings.apiKey){ setError('Add your OpenRouter API key in Settings.'); return } setAiBusy(true);
        try{
          const messages = buildMessages();
          const body = { model: settings.model||'openrouter/auto', messages, temperature:0.7, max_tokens:160 };
          const resp=await fetch(settings.endpoint||'https://openrouter.ai/api/v1/chat/completions',{
            method:'POST',
            headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+settings.apiKey,'HTTP-Referer':location.origin,'X-Title':'Memory Lane Local' },
            body: JSON.stringify(body)
          });
          if(!resp.ok) throw new Error('HTTP '+resp.status);
          const data=await resp.json();
          const text=(data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) ? data.choices[0].message.content.trim() : '(AI had no comment)';
          onAddAIComment(text);
        }catch(e){ setError('AI request failed. Check endpoint, model, key, and CORS.'); console.error(e) } finally { setAiBusy(false); }
      };

      const sortedComments=[...(post.comments||[])].sort((a,b)=>a.createdAt-b.createdAt);

      return (
        <article className="rounded-2xl bg-neutral-900/90 backdrop-blur border border-neutral-700 overflow-hidden">
          <div className="p-4 flex items-start gap-3 relative">
            <div className="w-10 h-10 rounded-full bg-neutral-700 overflow-hidden flex-shrink-0">
              {post.author.avatarDataUrl&&<img src={post.author.avatarDataUrl} className="w-full h-full object-cover" alt="avatar"/>}
            </div>
            <div className="flex-1">
              <div className="flex items-start gap-2 justify-between">
                <div>
                  <div className="font-medium">{post.author.name}</div>
                  <div className="text-xs text-neutral-400">{fmtTime(post.createdAt)} • {timeAgo(post.createdAt)}</div>
                </div>
                <button className="text-xs text-red-400 hover:underline" onClick={onDelete}>Delete</button>
              </div>
              {post.text&&<div className="mt-1 text-sm whitespace-pre-wrap">{post.text}</div>}
              {post.imageDataUrl&&<img src={post.imageDataUrl} alt="post" className="mt-2 w-full max-h-[70vh] object-contain rounded-lg bg-neutral-800"/>}
              <div className="mt-3 grid grid-cols-3 gap-2 text-sm text-neutral-300">
                <button className="py-1 rounded hover:bg-neutral-800" onClick={onLike}>Like ({post.likes})</button>
                <button className="py-1 rounded hover:bg-neutral-800" onClick={submitComment}>Quick Comment</button>
                <button className="py-1 rounded hover:bg-neutral-800 disabled:opacity-60" disabled={aiBusy} onClick={askAI}>{aiBusy?'AI…':'AI Comment'}</button>
              </div>

              {/* Comments */}
              <div className="mt-3 space-y-3">
                {error&&<div className="text-xs text-red-400">{error}</div>}
                {sortedComments.map(c=> (
                  <div key={c.id} className="flex items-start gap-2">
                    <div className="w-7 h-7 rounded-full bg-neutral-700 flex-shrink-0 grid place-items-center text-[10px] text-neutral-300">{(c.author||'')[0]?.toUpperCase()||'U'}</div>
                    <div className="flex-1">
                      <div className="px-3 py-2 rounded-2xl bg-neutral-800">
                        <div className="text-xs font-medium">{c.author} <span className="text-[10px] font-normal text-neutral-400">· {fmtTime(c.createdAt)}</span></div>
                        <div className="text-sm mt-1 leading-relaxed">{c.text}</div>
                      </div>
                      <div className="mt-1 flex items-center gap-3 text-xs text-neutral-400 pl-1">
                        <button onClick={()=>onLikeComment(c.id)}>Like{c.likes?' ('+c.likes+')':''}</button>
                        <button className="text-red-400" onClick={()=>onDeleteComment(c.id)}>Delete</button>
                      </div>
                    </div>
                  </div>
                ))}
                <div className="flex items-center gap-2">
                  <input value={comment} onChange={e=>setComment(e.target.value)} onKeyDown={(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();submitComment()}}} placeholder="Write a comment… (Enter to post)" className="flex-1 h-10 px-3 rounded-full border border-neutral-700 bg-neutral-800 focus:outline-none" />
                  <button onClick={submitComment} className="h-10 px-4 rounded-full border border-neutral-700">Post</button>
                </div>
              </div>
            </div>
          </div>
        </article>
      );
    }

    function PrivacyModal({ onClose }){
      return (
        <div className="fixed inset-0 z-50">
          <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
          <div className="relative w-full h-full flex items-start justify-center p-4 overflow-auto">
            <div className="w-full max-w-xl mt-10 bg-neutral-900 rounded-2xl border border-neutral-700 shadow-xl p-5">
              <div className="flex items-center justify-between mb-3">
                <div className="font-semibold text-lg">Privacy Policy</div>
                <button onClick={onClose} className="text-sm">Close</button>
              </div>
              <div className="text-sm space-y-3 text-neutral-200">
                <p><b>Local Storage Only.</b> This app stores your profile, collections, posts, images, comments, and settings in your browser's <i>localStorage</i>. The app developer does not operate a server that receives or stores this data.</p>
                <p><b>AI Requests.</b> If you use AI Comment (manually or automatically), the app sends the post text, existing comments, and the post image (as a data URL) to the model provider you configure (by default, OpenRouter). These requests are made directly from your browser to the provider's API using your API key.</p>
                <p><b>Third‑Party Providers.</b> Your use of an AI provider is governed by that provider's terms and privacy policy. Do not include sensitive information you do not wish to share with that provider.</p>
                <p><b>Export/Import.</b> Exported files contain your data in JSON format. Keep them private.</p>
              </div>
              <div className="mt-4 text-right">
                <button className="h-9 px-3 rounded-full border border-neutral-700" onClick={onClose}>OK</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
